<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cubyz Addon Uploader</title>
<style>
  body { font-family: Arial, sans-serif; background: #0d1117; color: #eee; padding: 2rem; display: flex; flex-direction: column; align-items: center; }
  h1 { margin-bottom: 0.5rem; }
  p { color: #aaa; }
  form { background: #161b22; padding: 1.5rem; border-radius: 10px; max-width: 720px; width: 100%; }
  h2.section-title { border-bottom: 1px solid #30363d; padding-bottom: 0.3rem; margin-top: 1.5rem; color: #fff; }
  label { display: block; margin-top: 1rem; font-weight: bold; }
  input, textarea, select { width: 100%; padding: 0.6rem; border-radius: 6px; border: none; background: #21262d; color: #eee; margin-top: 0.3rem; }
  small { color: #777; display: block; margin-top: 0.2rem; }
  button { margin-top: 1.5rem; padding: 0.8rem 1.2rem; background: #238636; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
  button:hover { background: #2ea043; }
  #fetchBtn { background: #30363d; color: #ccc; margin-left: 8px; padding: 0.6rem 1rem; border-radius: 6px; cursor: not-allowed; }
  #fetchBtn.active { background: #238636; color: white; cursor: pointer; }
  #fetchStatus { margin-top: 0.2rem; color: #888; font-size: 0.9rem; }
</style>
</head>
<body>

<h1>Cubyz Addon Uploader</h1>
<p>Automatically upload your addon and create a pull request.</p>

<form id="addonForm">

  <label>Addon Name</label>
  <input type="text" name="name" id="addonName" />

  <label>Addon ID (no spaces)</label>
  <div style="display:flex; align-items:center; gap:8px;">
    <input type="text" name="id" id="addonId" required />
    <button id="fetchBtn" type="button">Fetch</button>
  </div>
  <small id="fetchStatus"></small>

  <label>Author</label>
  <input type="text" name="author" id="addonAuthor" />

  <label>Version</label>
  <input type="text" name="version" id="addonVersion" value="0.0.0" />

  <label>Short Description</label>
  <input type="text" name="shortDescription" id="shortDescription" maxlength="120" />

  <label>Long Description</label>
  <textarea name="longDescription" id="longDescription" rows="5"></textarea>

  <label>Addon Icon (PNG)</label>
  <input type="file" name="icon" id="addonIcon" accept="image/png" />

  <label>Banner / Background (PNG)</label>
  <input type="file" name="banner" id="addonBanner" accept="image/png" />

  <label>Addon .zip File</label>
  <input type="file" name="addonZip" id="addonZip" accept=".zip" />

  <label>Patch Notes</label>
  <textarea name="patchNotes" id="patchNotes" rows="2" disabled placeholder="(enabled when .zip selected)"></textarea>

  <label>Tags (comma separated)</label>
  <input type="text" name="tags" id="tags" />

  <label>Cubyz Version Compatibility</label>
  <input type="text" name="cubyzVersion" id="cubyzVersion" />

  <button type="submit">Upload Addon</button>
</form>

<script>
const form = document.getElementById("addonForm");
const workerUrl = "https://cubyz-addon-uploader.jankajnicolas.workers.dev";
const fetchBtn = document.getElementById("fetchBtn");
const addonIdInput = document.getElementById("addonId");
const fetchStatus = document.getElementById("fetchStatus");
const patchNotes = document.getElementById("patchNotes");
const addonZip = document.getElementById("addonZip");

// --- Enable Patch Notes only when .zip selected ---
addonZip.addEventListener("change", () => {
  if (addonZip.files.length > 0) {
    patchNotes.disabled = false;
  } else {
    patchNotes.disabled = true;
    patchNotes.value = "";
  }
});

// --- Enable/disable Fetch button based on ID input ---
addonIdInput.addEventListener("input", () => {
  const id = addonIdInput.value.trim();
  if (id) {
    fetchBtn.classList.add("active");
    fetchBtn.disabled = false;
  } else {
    fetchBtn.classList.remove("active");
    fetchBtn.disabled = true;
  }
  fetchStatus.textContent = "";
});

// --- Fetch existing addon info ---
fetchBtn.addEventListener("click", async () => {
  const id = addonIdInput.value.trim();
  if (!id) return;
  fetchStatus.textContent = "Fetching...";
  fetchStatus.style.color = "#888";

  try {
    const res = await fetch(`${workerUrl}?id=${encodeURIComponent(id)}`);
    const data = await res.json();

    if (!data.ok) throw new Error(data.error || "Not found");

    const addon = data.addon;
    fetchStatus.textContent = "✅ Addon found and loaded.";
    fetchStatus.style.color = "lightgreen";

    // Fill the form
    document.getElementById("addonName").value = addon.name || "";
    document.getElementById("addonAuthor").value = addon.author || "";
    document.getElementById("addonVersion").value = addon.version || "";
    document.getElementById("shortDescription").value = addon.description || "";
    document.getElementById("longDescription").value = addon.longDescription || "";
    document.getElementById("tags").value = (addon.tags || []).join(", ");
    document.getElementById("cubyzVersion").value = addon.cubyzVersion || "";

  } catch (err) {
    console.error("Fetch failed:", err);
    fetchStatus.textContent = "❌ Addon not found or fetch failed.";
    fetchStatus.style.color = "red";
  }
});

// --- Handle submission ---
form.addEventListener("submit", async e => {
  e.preventDefault();
  const data = new FormData(form);

  console.log("Submitting addon with fields:");
  for (const [key, val] of data.entries()) {
    console.log(key, val instanceof File ? `[File: ${val.name}]` : val);
  }

  try {
    const res = await fetch(workerUrl, { method: "POST", body: data });
    const text = await res.text();
    console.log("Worker response text:", text);

    let json;
    try {
      json = JSON.parse(text);
    } catch {
      alert("❌ Worker returned non-JSON response:\n" + text.slice(0, 200));
      return;
    }

    if (json.ok) {
      alert("✅ Uploaded successfully! Pull request:\n" + json.pr_url);
      window.open(json.pr_url, "_blank");
    } else {
      alert("❌ Error: " + (json.error || JSON.stringify(json)));
    }
  } catch (err) {
    alert("Network or server error: " + err.message);
  }
});
</script>

</body>
</html>
